{% extends "network/layout.html" %}
{% load static %}

{% block body %}
<div class="content">
    {% if user.is_authenticated %}
    <div class="post">
        <input type="text" name="post-content" id="post-content-input" placeholder="Write what's on your mind ....">
        <button id="post-btn">Post</button>
    </div>

    <h3 id="posts_topic">Following Posts</h3>

    {% else %}
    <h3 id="posts_topic">All Posts</h3>
    {% endif %}

    <div class="content-posts">

        {% for post in posts %}
    <div class="post-container">
        <h1> {{post.user}} </h1>
        <p>{{post.content}}</p>
        {% if user.is_authenticated %}
            <button data-like="{% if user in post.likes.all %}true{% else %}fale{% endif %}" data-post_id="{{ post.id }}" id="like-btn">
                {% if user not in post.likes.all %}
                    👍
                {% else %}
                    👎
                {% endif %}
            </button>
        {% endif %}

    </div>
    {% empty %}
    <h1>No Posts.</h1>
    <p>Go to search for some random posts</p>
    {% endfor %}

    </div>
</div>
{% endblock %}


{% block script %}
<script src="{% static 'network/index.js' %}"></script>
<script>

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelector("#post-btn").addEventListener('click', () => {
            let text = document.querySelector("#post-content-input").value;
            let csrftoken = getCookie('csrftoken');
            fetch('post', {
                method: "POST",
                headers: { "X-CSRFToken": csrftoken },
                body: JSON.stringify({
                    content: text
                })
            })
                .then(response => response.json())
                .then(response => {
                    document.querySelector("#post-content-input").value = "";
                    console.log(response);
                })
        })
        document.querySelectorAll('#like-btn').forEach(btn => {
            btn.addEventListener('click', (event) => {
                let csrftoken = getCookie('csrftoken');
                let user = "{{ user.id }}";
                let liked = event.target.dataset.like === 'true';
                let post = event.target.dataset.post_id;

                fetch('/addlike', {
                    method: "PUT",
                    headers: { "X-CSRFToken": csrftoken },
                    body: JSON.stringify({
                        user_id: user,
                        like: !liked,
                        post: post,
                    })
                })
                .then(response => response.json())
                .then(response => {
                    if (!liked) {
                        event.target.innerHTML = '👎';
                        event.target.dataset.like = !liked;
                    } else {
                        event.target.textContent = '👍';
                        event.target.dataset.like = !liked;
                    }
                });
            });
        });


    })


</script>
{% endblock %}